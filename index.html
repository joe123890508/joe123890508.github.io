<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>表單轉 PDF（強制 16:9，完整顯示）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 0; /* 移除 body 預設 margin */
    }
    label, input, textarea {
      display: block;
      margin: 0.5em 0;
    }
    .form-container {
      max-width: 800px;
      border: 1px solid #ccc;
      padding: 1em;
      min-height: 270mm;
      margin: 1em auto; /* 讓容器置中並且上下有空間 */
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    .form-container, 
    .form-container > * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .form-container p {
      margin: 0.2em 0; /* 避免 p 標籤過大間距 */
    }
    .image-wrapper {
      width: 180mm;
      height: 101.25mm; /* 16:9 */
      margin: 10px 0;
      page-break-inside: avoid;
    }
    #preview-image {
      width: 100%;
      height: 100%;
      object-fit: fill; /* 拉伸填滿，變形沒關係 */
      display: none;
    }
    #preview-image.visible {
      display: block;
    }

    #container {
      height: 300px; /* 或你要的高度 */
      margin: 10px 0;
    }
    #map {height: 88%;}
    .basemaps {
      padding: 4px;
    }
    .basemaps.closed .basemap {
      display: none;
    }
    .basemaps.closed .basemap.alt {
      display: inline-block;
    }
    .basemaps.closed .basemap.alt h4 {
      display: none;
    }
    .basemap {
      display: inline-block; /* todo: flexbox? */
      cursor: pointer;
    }
    .basemap.active img {
      border-color: orange;
      box-shadow: 2px 2px 4px #000;
    }
    .basemap img {
      width: 64px;
      border: 2px solid #FFF;
      margin: 0 2px;
      border-radius: 40px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.65)
    }
  </style>
</head>
<body>

  <h1 style="text-align:center;">輸入表單並轉成 PDF</h1>

  <div class="form-container" id="form-content">
    <label for="county">縣市：</label>
    <select id="county_list" onchange="change_county(this.value)"></select>
    <label for="town">行政區：</label>
    <select id="town_list" onchange="change_town(this.value)"></select>
    <label for="dist">地段：</label>
    <select id="village_list" onchange="change_village(this.value)"></select>
    
    <input type="pmno" id="pmno" name="pmno" />
    <input type="pcno" id="pcno" name="pcno" />
    <input type="button" value="確認盤點內容" id="find_land" class="button">

    <label for="message">備註：</label>
    <textarea id="message" name="message" rows="2"></textarea>
    <input type="button" value="取得 GPS 位置" id="get_gps" class="button mt-2" />

    <div id="container">
        <div id="map">
          <div class="modal fade" id="featureModal" tabindex="-1" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title text-primary" id="feature-title"></h4>
                  <button class="close" type="button" data-dismiss="modal">×</button>
                </div>
                <div class="modal-body" id="feature-info"></div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" id="google_map">在Google地圖開啟</button>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

    <label for="image">上傳圖片：</label>
    <input type="file" id="image" accept="image/*" />

    <div class="image-wrapper">
      <img id="preview-image" src="" alt="圖片預覽" />
    </div>
  </div>

  <div style="text-align:center; margin: 2em;">
    <button onclick="generatePDF()">匯出為 PDF</button>
  </div>

  <script>
    var map = L.map('map', {center: [22.689,120.436], zoom: 15, zoomControl: true});
    L.control.scale({position: 'bottomleft'}).addTo(map);

    var basemaps = [
      L.tileLayer('https://wmts.nlsc.gov.tw/wmts/{id}/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
      maxZoom: 20,
      id: 'EMAP',
      label: '測試一' }),
      L.tileLayer('https://wmts.nlsc.gov.tw/wmts/{id}/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
      maxZoom: 20,
      id: 'PHOTO2',
      label: '測試二' }),
      L.tileLayer('https://wmts.nlsc.gov.tw/wmts/{id}/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
        maxZoom: 20,
        id: 'LUIMAP',
        label: '測試三' })
    ];
  
    L.Control.Basemaps=L.Control.extend({_map:null,includes:L.Evented?L.Evented.prototype:L.Mixin.Event,options:{position:"bottomright",tileX:0,tileY:0,tileZ:0,layers:[]},basemap:null,onAdd:function(e){this._map=e;var t=L.DomUtil.create("div","basemaps leaflet-control closed");return L.DomEvent.disableClickPropagation(t),L.Browser.touch||L.DomEvent.disableScrollPropagation(t),this.options.basemaps.forEach(function(s,o){var a,i="basemap";if(0===o?(this.basemap=s,this._map.addLayer(s),i+=" active"):1===o&&(i+=" alt"),s.options.iconURL)a=s.options.iconURL;else{var l={x:this.options.tileX,y:this.options.tileY};if(a=L.Util.template(s._url,L.extend({s:s._getSubdomain(l),x:l.x,y:s.options.tms?s._globalTileRange.max.y-l.y:l.y,z:this.options.tileZ},s.options)),s instanceof L.TileLayer.WMS){s._map=e;var n=s.options.crs||e.options.crs,r=L.extend({},s.wmsParams),m=parseFloat(r.version);r[m>=1.3?"crs":"srs"]=n.code;var p=L.point(l);p.z=this.options.tileZ;var c=s._tileCoordsToBounds(p),d=n.project(c.getNorthWest()),h=n.project(c.getSouthEast()),v=(m>=1.3&&n===L.CRS.EPSG4326?[h.y,d.x,d.y,h.x]:[d.x,h.y,h.x,d.y]).join(",");a+=L.Util.getParamString(r,a,s.options.uppercase)+(s.options.uppercase?"&BBOX=":"&bbox=")+v}}var b=L.DomUtil.create("div",i,t),u=L.DomUtil.create("img",null,b);u.src=a,s.options&&s.options.label&&(u.title=s.options.label),L.DomEvent.on(b,"click",function(){if(this.options.basemaps.length>2&&L.Browser.mobile&&L.DomUtil.hasClass(t,"closed"))L.DomUtil.removeClass(t,"closed");else if(s!=this.basemap){e.removeLayer(this.basemap),e.addLayer(s),s.bringToBack(),e.fire("baselayerchange",s),this.basemap=s,L.DomUtil.removeClass(t.getElementsByClassName("basemap active")[0],"active"),L.DomUtil.addClass(b,"active");var a=(o+1)%this.options.basemaps.length;L.DomUtil.removeClass(t.getElementsByClassName("basemap alt")[0],"alt"),L.DomUtil.addClass(t.getElementsByClassName("basemap")[a],"alt"),L.DomUtil.addClass(t,"closed")}},this)},this),this.options.basemaps.length>2&&!L.Browser.mobile&&(L.DomEvent.on(t,"mouseenter",function(){L.DomUtil.removeClass(t,"closed")},this),L.DomEvent.on(t,"mouseleave",function(){L.DomUtil.addClass(t,"closed")},this)),this._container=t,this._container}}),L.control.basemaps=function(e){return new L.Control.Basemaps(e)};

    map.addControl(L.control.basemaps({
      basemaps: basemaps,
      tileX: 854,  //tile X coordinate
      tileY: 444,  //tile Y coordinate
      tileZ: 10   //tile zoom level
    }));

    const imageInput = document.getElementById('image');
    const previewImage = document.getElementById('preview-image');

    imageInput.addEventListener('change', function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImage.src = e.target.result;
          previewImage.classList.add('visible');
        };
        reader.readAsDataURL(file);
      } else {
        previewImage.src = '';
        previewImage.classList.remove('visible');
      }
    });

  async function generatePDF() {
    const original = document.getElementById('form-content');
    const clone = original.cloneNode(true);
    // 移除 clone 中的「確認盤點內容」按鈕
    const findLandBtn = clone.querySelector('#find_land');
    if (findLandBtn) {
      findLandBtn.remove();
    }

    // 從原始 map 元素截圖，不要用 clone 裡的
    const mapElementOriginal = document.querySelector('#map');
    const mapElementClone = clone.querySelector('#map');

    if (mapElementOriginal && mapElementClone) {
      try {
        const canvas = await html2canvas(mapElementOriginal, {
          useCORS: true,
          scale: 2,
          scrollX: 0,
          scrollY: -window.scrollY,
          windowWidth: document.documentElement.clientWidth,
          windowHeight: document.documentElement.clientHeight,
        });
        const imgDataUrl = canvas.toDataURL('image/png');
        const img = document.createElement('img');
        img.src = imgDataUrl;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'fill';
        mapElementClone.parentNode.replaceChild(img, mapElementClone);
      } catch (error) {
        console.error('地圖截圖失敗:', error);
      }
    }

    // 把原始頁面上的所有輸入欄位轉成純文字段落（保留選取值）const originalElements = Array.from(original.querySelectorAll('input, textarea, select'));
const originalElements = Array.from(original.querySelectorAll('input, textarea, select'));
const cloneElements = Array.from(clone.querySelectorAll('input, textarea, select'));

cloneElements.forEach(cloneEl => {
  const name = cloneEl.getAttribute('name') || cloneEl.getAttribute('id');
  const originalEl = originalElements.find(el =>
    (el.getAttribute('name') || el.getAttribute('id')) === name
  );

  if (!originalEl) return;

  const label = cloneEl.previousElementSibling;
  const labelText = label ? label.textContent.trim() : '';

  const p = document.createElement('p');
  let valueText = '';

  if (originalEl.tagName.toLowerCase() === 'select') {
    valueText = originalEl.options[originalEl.selectedIndex]?.text || '';
  } else {
    valueText = originalEl.value;
  }

  p.textContent = `${labelText} ${valueText}`;
  p.style.margin = '0.2em 0';

  if (label) label.remove();
  cloneEl.replaceWith(p);
});
  // 圖片處理 (form中的預覽圖片)
  const imgPreview = clone.querySelector('#preview-image');
  if (imgPreview) {
    if (!imgPreview.src) {
      imgPreview.remove();
    } else {
      imgPreview.style.width = '100%';
      imgPreview.style.height = '100%';
      imgPreview.style.objectFit = 'fill';
      imgPreview.classList.add('visible');
    }
  }
  // 移除空白節點，避免多餘空白
  clone.querySelectorAll('p, div').forEach(el => {
    if (!el.textContent.trim() && el.querySelectorAll('*').length === 0) {
      el.remove();
    }
  });
  // 等圖片載入完成後匯出 PDF
  const waitForImage = new Promise(resolve => {
    if (!imgPreview || (imgPreview.complete && imgPreview.naturalHeight !== 0)) {
      resolve();
    } else {
      imgPreview.onload = () => resolve();
      imgPreview.onerror = () => resolve();
    }
  });
  await waitForImage;
  const opt = {
    margin: 10,
    filename: 'form-16x9.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: {
      scale: 2,
      useCORS: true,
      scrollY: 0,
    },
    jsPDF: {
      unit: 'mm',
      format: 'a4',
      orientation: 'portrait',
    },
  };
  html2pdf().set(opt).from(clone).save();
}


google_map_url = 'https://www.google.com/maps/search/?api=1&query='
var pois = L.geoJson(null, {
  style: function (feature) {
    return {
      weight: 1.5, // 線的寬度（預設為 3）
    };
  },
  pointToLayer: (feature, latlng) => {
    return L.marker(latlng);},
  onEachFeature: (feature, layer) => {
      layer.on("click", () => {
          table_content = '<table border="1">'
          for (let key in feature.properties) {
            table_content = table_content + '<tr><th>' + key + '</th><td>' + feature.properties[key] + '</td></tr>'
          };
          table_content = table_content + '</table>'
          document.getElementById("feature-info").innerHTML = table_content
          document.getElementById("feature-title").innerHTML = feature.properties['LANDNO']
          $('#featureModal').modal('show')
          const center = layer.getBounds().getCenter()
          const lat = center.lat
          const lng = center.lng
          url = google_map_url + lat + ',' +lng
          $('#google_map').off().on('click', function () {
            window.open(url);
          });
          $('.close').click(function() {
            $('#featureModal').modal('hide');
          });
        });
  }
})
  let global_json;
  fetch ("http://140.116.41.233:9487/getdata")
    .then(response => response.json())
    .then(json => {
      data=json.features;
      pois.addData(data);
      map.addLayer(pois);
      var county_list=document.getElementById("county_list");
      town_list.innerHTML="<option value>請選擇鄉鎮</option>";
      village_list.innerHTML="<option value>請選擇地段</option>";
      global_json = json
      let inner="<option value>請選擇縣市</option>";
        let inner_list = [];
        for (let i=0;i<json['features'].length;i++){
          let county = json['features'][i].properties.RCOUNTY;
          if (!inner_list.includes(county)){
            inner=inner+'<option value='+county+'>'+county+'</option>';
            inner_list.push(county);
          }
        };
      county_list.innerHTML=inner;
    });

  function change_county(_county) {
    village_list.innerHTML="<option value>請選擇地段</option>";
    var inner="<option value>請選擇地段</option>";
    //console.log(county);
    let inner_list = []
    for (let i=0;i<global_json['features'].length;i++){
      if (_county === global_json['features'][i].properties.RCOUNTY){
        let town = global_json['features'][i].properties.RTOWN;
        if (!inner_list.includes(town)){
            inner=inner+'<option value='+town+'>'+town+'</option>';
            inner_list.push(town);
        };
      };
    };
    town_list.innerHTML=inner;
  };

  function change_town(_town) {
    var inner="<option value>請選擇鄉鎮</option>";
    //console.log(county);
    let inner_list = []
    for (let i=0;i<global_json['features'].length;i++){
      if (_town === global_json['features'][i].properties.RTOWN){
        let village = global_json['features'][i].properties.scno;
        if (!inner_list.includes(village)){
            inner=inner+'<option value='+village+'>'+village+'</option>';
            inner_list.push(village);
        };
      };
    };
    village_list.innerHTML=inner;
  };

  function change_village(_village) {
    village = _village;
  }

  var button = document.querySelector("#find_land");
  button.addEventListener("click",
    function () {
      _selected = -1
      inputValue1 = document.getElementById("pmno").value;
      inputValue2 = document.getElementById("pcno").value;
      for (let i=0;i<global_json['features'].length;i++){
        if (village === global_json['features'][i].properties.scno){
          if (inputValue1 === global_json['features'][i].properties.pmno){
            if (inputValue2 === global_json['features'][i].properties.pcno){
              _selected = i
              break;
            };
          };
        };
      }
  if (_selected === -1) {
    window.alert("查無地號，請確認後重新查詢！");
    } else {
      const feature = global_json['features'][_selected];
      let coords = feature.geometry;
      // 支援點線面的中心點
      let center;
      if (coords.type === "Point") {
        center = {
          lat: coords.coordinates[1],
          lng: coords.coordinates[0]
        };
      } else {
        // 線或面 — 使用 Leaflet 來取得中心
        const layer = L.geoJSON(feature);
        center = layer.getBounds().getCenter();
      }
      map.flyTo(center, 18, { duration: 1.5 }); // 移動到該地點
      L.popup()
      .setLatLng(center)
      .setContent("地號：" + feature.properties.LANDNO)
      .openOn(map);
      }
    }
  )
  // 定義全域變數來儲存 GPS marker，避免重複疊加
let gpsMarker = null;

document.getElementById("get_gps").addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("此瀏覽器不支援 GPS 定位！");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // 清除舊的 GPS marker
      if (gpsMarker) {
        map.removeLayer(gpsMarker);
      }

      // 新增 GPS marker
      gpsMarker = L.marker([lat, lng]).addTo(map);

      // 將地圖移動到當前位置
      map.flyTo([lat, lng], 17); // 可調整 zoom
    },
    (error) => {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          alert("您拒絕了 GPS 存取。");
          break;
        case error.POSITION_UNAVAILABLE:
          alert("無法取得您目前的位置。");
          break;
        case error.TIMEOUT:
          alert("定位逾時，請再試一次。");
          break;
        default:
          alert("發生未知錯誤。");
      }
    }
  );
});

  </script>

</body>
</html>
